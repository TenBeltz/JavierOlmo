---
interface Exercise {
  id: number;
  favorito: boolean;
  titulo: string;
  video?: string;
  video_url?: string;
  fecha: string;
  creador: number;
  subida?: number;
  categorias: number[];
  usuarios_fav?: number[];
}

interface Category {
  id: number;
  titulo: string;
  aprobada?: boolean;
  categoria_padre?: number;
  categorias_hijas?: number[];
  subida_por?: number;
}

let exercises: Exercise[] = [];
let filteredExercises: Exercise[] = [];
let categories: Category[] = [];
let loading = true;
let error: string | null = null;
let token: string | undefined;

if (Astro.cookies.has("token")) {
  const tokenCookie = Astro.cookies.get("token");
  token = tokenCookie.value;
}

function extractYouTubeId(url: string): string | null {
  const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
  const match = url.match(regex);
  return match ? match[1] : null;
}

async function fetchData(): Promise<void> {
  try {
    if (!token) {
      throw new Error('Token is not available');
    }
    
    const [exercisesResponse, categoriesResponse] = await Promise.all([
      fetch('https://api.javierolmotraining.es/ejercicios/', {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
          'Authorization': `Token ${token}`,
        },
      }),
      fetch('https://api.javierolmotraining.es/categorias/', {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
          'Authorization': `Token ${token}`,
        },
      }),
    ]);

    if (!exercisesResponse.ok || !categoriesResponse.ok) {
      throw new Error('Failed to fetch data');
    }

    [exercises, categories] = await Promise.all([
      exercisesResponse.json(),
      categoriesResponse.json(),
    ]);
  } catch (err) {
    console.error('Fetch error:', err);
    error = err instanceof Error ? err.message : 'Failed to fetch data';
  } finally {
    loading = false;
  }
}

function filterExercises(searchValue?: string, selectedCategory?: number, selectedSubcategory?: number): void {
  let filtered = [...exercises];

  if (searchValue) {
    filtered = filtered.filter(item =>
      item.titulo.toLowerCase().includes(searchValue.toLowerCase())
    );
  }

  if (selectedCategory) {
    filtered = filtered.filter(item => item.categorias.includes(selectedCategory));
  }

  if (selectedSubcategory) {
    filtered = filtered.filter(item => item.categorias.includes(selectedSubcategory));
  }

  filteredExercises = filtered;
}

async function handleRequest(): Promise<void> {
  await fetchData();

  const { request } = Astro;
  const url = new URL(request.url);
  
  const searchValue = url.searchParams.get('search-exercise');
  const selectedCategory = url.searchParams.get('categories') ? Number(url.searchParams.get('categories')) : undefined;
  const selectedSubcategory = url.searchParams.get('subcategories') ? Number(url.searchParams.get('subcategories')) : undefined;

  filterExercises(searchValue, selectedCategory, selectedSubcategory);
}

await handleRequest();
---

<style>
  select { background-image: none; }
</style>

<form class="flex flex-col flex-wrap gap-8 mx-4 mb-8 text-black" method="get">
  <div>
    <label class="relative flex items-center max-w-md mx-auto">
      <input
        type="search"
        name="search-exercise"
        id="search-exercise"
        placeholder="Buscar ejercicio"
        class="w-full rounded-full bg-black border-[1.5px] grow text-white border-white focus:border-white placeholder:text-gray-300"
      />
      <button class="absolute text-white right-3" type="submit">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
        </svg>
      </button>
    </label>
  </div>

  <div class="flex flex-wrap gap-1">
    <button type="submit" class="px-4 py-2 bg-black border rounded-md text-electric-lime hover:text-lime-zest hover:border-lime-zest border-electric-lime">Filtrar</button>
    <button id="clear-filters" type="reset" class="px-4 py-2 bg-black border rounded-md text-electric-lime hover:text-lime-zest hover:border-lime-zest border-electric-lime">Quitar filtros</button>
    
    {categories.filter(parentcategory => !parentcategory.categoria_padre)
      .map(category => 
        <label for={`select-categories-${category.id}`} class="relative flex flex-col">
          <span id={`span-category-${category.titulo}`} class="px-4 py-2 rounded-md bg-electric-lime hover:bg-lime-zest hover:cursor-pointer">{category.titulo}</span>
          <select id={`select-categories-${category.id}`} multiple class="absolute z-10 hidden rounded-md top-11 categories bg-electric-lime hover:cursor-pointer hover:bg-lime-zest" name="categories">
            <option value="">{category.titulo}</option>
            {category.categorias_hijas?.map(subcategoryId => {
              const subcategory = categories.find(cat => cat.id === subcategoryId);
              return subcategory ? <option value={subcategory.id}>{subcategory.titulo}</option> : null;
            })}
          </select>
        </label>
      )
    }
  
    {categories.filter(subcategory => subcategory.categoria_padre && subcategory.categorias_hijas.length !== 0)
      .map(subcategory => 
        <label for={`select-subcategories-${subcategory.id}`} class="relative flex flex-col">
          <span id={`span-subcategory-${subcategory.titulo}`} class="px-4 py-2 rounded-md bg-electric-lime hover:bg-lime-zest hover:cursor-pointer">{subcategory.titulo}</span>
          <select id={`select-subcategories-${subcategory.id}`} multiple class="absolute z-10 hidden px-4 py-2 rounded-md top-11 subcategories bg-electric-lime hover:cursor-pointer hover:bg-lime-zest" name="subcategories">
            <option value="">{subcategory.titulo}</option>
            {subcategory.categorias_hijas?.map(subsubcategoryId => {
              const subsubcategory = categories.find(cat => cat.id === subsubcategoryId);
              return subsubcategory ? <option value={subsubcategory.id}>{subsubcategory.titulo}</option> : null;
            })}
          </select>
        </label>
      )
    }
  </div>
</form>

{loading ? (
  <div class="py-4 text-center">Loading...</div>
) : error ? (
  <div class="py-4 text-center text-red-600">{error}</div>
) : (
  <div class="grid gap-4 mx-4 text-black xs:grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5">
    {filteredExercises.map(exercise => (
      <div id={exercise.id.toString()} data-is-favorite={`${exercise.favorito.valueOf()}`} class="flex flex-col justify-between p-4 bg-white hover:cursor-pointer exercise gap-y-2 rounded-3xl">
        <div>
          {exercise.video_url ? (
            <video src='../../public/videos/example-tmp.mp4' class="rounded-lg"></video>
            <dialog class="modal">
              <div class="modal-box rounded-xl">
                <h3 class="mb-6 text-lg font-bold text-center text-white">{exercise.titulo}</h3>
                <div>
                  <video src='../../public/videos/example-tmp.mp4' controls class="w-full rounded-lg"></video>
                </div>
                <div class="modal-action">
                  <form method="dialog">
                    <button class="text-black btn bg-electric-lime hover:bg-lime-zest">Cerrar</button>
                  </form>
                </div>
              </div>
            </dialog>
          ) : (
            <p>No hay video disponible</p>
          )}
        </div>
        <div>
          <div class="flex justify-between">
            <span>Nivel</span>
            <button class="favorite-button">
              {exercise.favorito === false ? (
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z" />
                </svg>
              ) : (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                  <path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.006 5.404.434c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.434 2.082-5.005Z" clip-rule="evenodd" />
                </svg>
              )}
            </button>
          </div>
          <div class="flex items-center justify-center flex-grow text-center">
            <span>{exercise.titulo}</span>
          </div>
        </div>
      </div>
    ))}
  </div>
)}

<script>
  const exercises = document.querySelectorAll('.exercise');

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }

  exercises.forEach(exercise => {
    const favoriteButton = exercise.querySelector('.favorite-button');

    exercise.addEventListener('click', event => {
      const modal = exercise.querySelector('dialog');
      if (modal instanceof HTMLDialogElement) {
        modal.showModal();
        event.stopPropagation();
      }
    });

    favoriteButton.addEventListener('click', async (event) => {
      event.stopPropagation();

      const exerciseId: string = exercise.getAttribute('id');
      const isFavorite: boolean = exercise.getAttribute('data-is-favorite').valueOf() === 'true';

      try {
        const token = getCookie('token');
        const url = `https://api.javierolmotraining.es/favorito/`;
        const method = isFavorite ? 'DELETE' : 'POST';
        
        const exercisesResponse = await fetch(url, {
          method,
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'Authorization': `Token ${token}`,
          },
          body: JSON.stringify({
            ejercicio_id: exerciseId
          })
        });

        console.log(exercisesResponse.json());

      } catch (error) {
        console.error('Error en la solicitud', error);
      }
    });
  })

  document.getElementById('clear-filters')?.addEventListener('click', () => {
    const url = new URL(window.location.href);
    url.search = '';
    window.location.href = url.toString();
  });
  
  document.addEventListener('DOMContentLoaded', () => {
    const token = document.cookie.split('; ').find(row => row.startsWith('token='));
    const tokenValue = token ? token.split('=')[1] : null;
  
    if (!tokenValue) {
      window.location.href = '/signin';
    }

    const categories: NodeListOf<HTMLSpanElement> = document.querySelectorAll('[id^="span-category-"], [id^="span-subcategory-"]');

    categories.forEach((category: HTMLSpanElement) => {
      category.addEventListener('click', () => {
        categories.forEach((cat: HTMLSpanElement) => {
          const selectCategories = cat.nextElementSibling as HTMLSelectElement | null;
          if (selectCategories && selectCategories !== category.nextElementSibling) {
            selectCategories.classList.add('hidden');
          }
        });

        const selectCategories = category.nextElementSibling as HTMLSelectElement | null;
        selectCategories?.classList.toggle('hidden');

        if (selectCategories) {
          const rect = category.getBoundingClientRect();
          const dropdownRect = selectCategories.getBoundingClientRect();
          const verticalMargin = 108;

          if (rect.left + dropdownRect.width > window.innerWidth) {
            selectCategories.style.left = 'auto';
            selectCategories.style.right = '0';
          } else {
            selectCategories.style.left = '0';
            selectCategories.style.right = 'auto';
          }

          if (rect.top + dropdownRect.height > window.innerHeight) {
            selectCategories.style.top = 'auto';
            selectCategories.style.bottom = `${verticalMargin}%`;
          } else {
            selectCategories.style.top = `${verticalMargin}%`;
            selectCategories.style.bottom = 'auto';
          }
        }
      });
    });
  });
</script>